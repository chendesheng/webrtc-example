<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title></title>
	<style type="text/css">
		.video {
			position: relative;
			width: 480px;
			height: 270px;
		}
		
		video {
			width: 100%;
		}
		
		#me {
			width: 100px;
			position: absolute;
			z-index: 1;
			top: 5px;
			right: 5px;
		}
		
		#you {
			width: 100%;
			height: 100%;
			background: black;
		}
	</style>
	<script src="https://webrtc.github.io/adapter/adapter-latest.js" type="text/javascript"></script>
	<script src="src/signaling.js" type="text/javascript"></script>
	<script src="src/p2pchat.js" type="text/javascript"></script>

	<script type="text/javascript">
		var p2pChat;
		var status;
		window.onload = function () {
			var $me = document.getElementById('me');
			var $you = document.getElementById('you');
			var $start = document.getElementById('start');
			var $stop = document.getElementById('stop');
			var $relayOnly = document.getElementById('relayOnly');
			var $localVideo = document.getElementById('localVideo');
			var $remoteVideo = document.getElementById('remoteVideo');
			var $requirePermission = document.getElementById('requirePermission');

			p2pChat = new P2PChat('default', $localVideo, $remoteVideo);
			status = 'new';

			p2pChat.onevent(function onVideoChatEvent(type, data) {
				console.log(type);
				if (type === 'error') {
					console.error(data);
				} else if (type === 'close') {
					status = 'new';
				}
			});

			$start.onclick = function onClickCall() {
				var p = Promise.resolve();
				if ($requirePermission.checked) {
					p = p2pChat.requirePermission(true)
				}
				p.then(function () {
					status = 'starting';
					return p2pChat.start(true, $relayOnly.checked);
				}).then(function () {
					p2pChat.getPeerConnectionStats();
					return Promise.resolve();
				}).catch(function (err) {
					console.log(err);
					status = 'new';
					return Promise.resolve();
				});
			};

			$stop.onclick = function onClickHangup() {
				p2pChat.stop();
			};

			setInterval(function () {
				switch (status) {
					case 'new':
						$start.disabled = false;
						$stop.disabled = true;
						break;
					case 'starting':
						$start.disabled = true;
						$stop.disabled = false;
						break;
					case 'started':
						$start.disabled = true;
						$stop.disabled = false;
						break;
				}
			}, 16.6);
		};
	</script>
</head>

<body>
	<h3>
		Audio &amp; Video Chat Example
	</h3>
	<p>
		配置hosts：<br>120.199.9.10 hosted.comm100.com
	</p>
	<p>
		<label>Room: </label><input type="text" id="room" value="default" />
		<p>同一个room<strong>只能</strong>有两个人</p>
	</p>
	<p>
		<label>Relay only: </label><input type="checkbox" id="relayOnly" /> 总是使用TURN服务器中转
	</p>
	<p>
		<label>Require permission before start: </label><input type="checkbox" checked id="requirePermission" />
	</p>
	<p>
	</p>
	<P>
		<button id="start">Start</button>
		<button id="stop">Stop</button>
	</p>

	<div class="video">
		<div id="me">
			<video id="localVideo"></video>
		</div>
		<div id="you">
			<video id="remoteVideo"></video>
		</div>
	</div>
</body>

</html>