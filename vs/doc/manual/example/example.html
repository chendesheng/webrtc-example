<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">Example</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container manual-root" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div class="manual-toc-root">
  
<div data-ice="manual" data-toc-name="example">
    <ul class="manual-toc">
      
    </ul>
  </div>
<div data-ice="manual" data-toc-name="reference">
    <ul class="manual-toc">
      
    <li data-ice="manualNav" class="indent-h1 manual-color manual-color-reference" data-section-count="&#x25A0;&#x25A0;&#x25A0;&#x25A0;&#x25A0;" data-link="identifiers.html"><a href="identifiers.html" data-ice="link">Reference</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="identifiers.html"><a href="identifiers.html#variable" data-ice="link">Variable</a></li>
<li data-ice="manualNav" class="indent-h2" data-link="identifiers.html"><a href="identifiers.html#typedef" data-ice="link">Typedef</a></li>
</ul>
  </div>
</div>
</nav>

<div class="content" data-ice="content"><div class="github-markdown">
  <div class="manual-breadcrumb-list">
    <a href="./manual/./index.html">Manual</a>
    <span>&#xBB;</span>
    <span data-ice="title">Example</span>
  </div>
  <div data-ice="content"><pre><code class="lang-javascript"><code class="source-code prettyprint">// chat&#x76F8;&#x5173;&#x7684;&#x4F8B;&#x5B50;
Comm100API.onWindowWillDisplay = function (chatWindow) {
  const chatContent = chatWindow.chatContent;

  // &#x4EE5;&#x4E0B;&#x5C55;&#x793A;&#x4E00;&#x4E9B;&#x9488;&#x5BF9;&#x5355;&#x4E2A;&#x6D88;&#x606F;&#x7684;&#x5904;&#x7406;&#x4F8B;&#x5B50;
  chatContent.onChange({
    /**
     * &#x5728;&#x524D;&#x53F0;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;&#x9690;&#x85CF;&#x4FE1;&#x7528;&#x5361;&#x5361;&#x53F7;&#x7684;&#x529F;&#x80FD;
     */
    &apos;visitor-text&apos;: function (message) {
      /* &#x83B7;&#x53D6;&#x5230;&#x8BBF;&#x5BA2;&#x53D1;&#x9001;&#x7684;&#x6587;&#x5B57;&#x6D88;&#x606F;&#x5185;&#x5BB9; */
      const text = message.text;
      /* &#x7528;&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;&#x5C06;&#x5176;&#x4E2D;&#x7684;&#x4FE1;&#x7528;&#x5361;&#x53F7;&#x66FF;&#x6362;&#x4E3A;&#x661F;&#x53F7; */
      text.replace(/credit-card-pattern-here/, &apos;*&apos;);
      /* &#x663E;&#x793A;&#x66FF;&#x6362;&#x540E;&#x7684;&#x6D88;&#x606F;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x539F;&#x59CB;&#x6D88;&#x606F; */
      return message;
    },
    /**
     * &#x5728;&#x524D;&#x53F0;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C; Skype &#x7684;&#x529F;&#x80FD;&#xFF0C;&#x5C06;&#x4E00;&#x4E2A; comm100.com &#x7F51;&#x7AD9;&#x5730;&#x5740;&#x6D88;&#x606F;&#xFF0C;&#x4FEE;&#x6539;&#x6210;&#x53EF;&#x70B9;&#x51FB;&#x7684; Comm100
     * Logo &#x56FE;&#x7247;&#x6D88;&#x606F;&#xFF0C;&#x56FE;&#x7247;&#x70B9;&#x51FB;&#x540E;&#x53EF;&#x8DF3;&#x8F6C;&#x5230;&#x5177;&#x4F53;&#x7684;&#x9875;&#x9762;
     */
    &apos;agent-url&apos;: function (message) {
      /* &#x83B7;&#x53D6;&#x6D88;&#x606F;&#x7684; URL */
      const link = message.link;
      /* &#x5BF9;&#x4E8E;&#x5176;&#x4ED6;&#x7F51;&#x7AD9;&#x7684; URL &#x5730;&#x5740;&#xFF0C;&#x4E0D;&#x505A;&#x5904;&#x7406; */
      if (!link.indexOf(&apos;comm100.com&apos;) &lt; 0) return message;
      /* &#x5C06; URL &#x6D88;&#x606F;&#x66FF;&#x6362;&#x6210;&#x56FE;&#x7247;&#x6D88;&#x606F; */
      return {
        type: &apos;agent-image&apos;,
        /* &#x56FE;&#x7247;&#x7684;&#x5730;&#x5740; */
        src: &apos;http://www.comm100.com/logo.png&apos;,
        /* &#x70B9;&#x51FB;&#x56FE;&#x7247;&#xFF0C;&#x8DF3;&#x8F6C;&#x5230;&#x539F;&#x6765;&#x7684;&#x5730;&#x5740; */
        link: link,
      };
    },
    /**
     * &#x5F53;&#x8BBF;&#x5BA2;&#x4F30;&#x8BA1;&#x7684;&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#x8F83;&#x957F;&#x65F6;&#xFF0C;&#x663E;&#x793A;&#x4E00;&#x6761;&#x6765;&#x81EA;&#x5BA2;&#x670D;&#x7684;&#x6D88;&#x606F;
     */
    &apos;waiting-queue&apos;: (function () {
      /* &#x786E;&#x4FDD;&#x8FD9;&#x6761;&#x6D88;&#x606F;&#x6700;&#x591A;&#x53EA;&#x663E;&#x793A;&#x4E00;&#x6B21; */
      let hasBeenShown = false;
      return function (message) {
        /* &#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x663E;&#x793A;&#x8FC7;&#x4E86;&#xFF0C;&#x5C31;&#x4E0D;&#x9700;&#x8981;&#x989D;&#x5916;&#x5904;&#x7406;&#x4E86; */
        if (hasBeenShown) return message;

        const queuePosition = message.queuePosition;
        const estimatedTime = message.estimatedTime;
        /* &#x5F53;&#x9884;&#x8BA1;&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#x8D85;&#x8FC7;&#x4E94;&#x5206;&#x949F;&#xFF0C;&#x6216;&#x961F;&#x5217;&#x524D;&#x9762;&#x8FD8;&#x6709;&#x81F3;&#x5C11;&#x5341;&#x4E2A;&#x4EBA;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x663E;&#x793A;&#x5BA2;&#x670D;&#x6D88;&#x606F; */
        if (estimatedTime &gt; 5 || queuePosition &gt; 10) {
          hasBeenShown = true;
          return [
            message,
            /* &#x591A;&#x63D2;&#x5165;&#x4E00;&#x6761;&#x5BA2;&#x670D;&#x6D88;&#x606F;&#xFF0C;&#x663E;&#x793A;&#x4E00;&#x4E9B;&#x4FE1;&#x606F; */
            {
              type: &apos;agent-text&apos;,
              text: &apos;Promotion goes here!&apos;,
            },
          ];
        }
        /* &#x5982;&#x679C;&#x7B49;&#x5F85;&#x7684;&#x65F6;&#x95F4;&#x4E0D;&#x957F;&#xFF0C;&#x76F4;&#x63A5;&#x663E;&#x793A;&#x5C31;&#x597D;&#x4E86; */
        return message;
      };
    }()),
    /**
     * &#x5F53;&#x8BBF;&#x5BA2;&#x53D1;&#x9001;&#x4E86;&#x9644;&#x4EF6;&#x4E4B;&#x540E;&#xFF0C;&#x663E;&#x793A;&#x4E00;&#x4E9B;&#x989D;&#x5916;&#x7684;&#x4FE1;&#x606F;
     */
    &apos;visitor-attachment&apos;: function (message) {
      const fileType = message.fileType;
      /* &#x4E0D;&#x63A5;&#x53D7;&#x9664;&#x4E86; pdf &#x4E4B;&#x5916;&#x7684;&#x9644;&#x4EF6;&#xFF0C;&#x5982;&#x679C;&#x5BA2;&#x6237;&#x53D1;&#x9001;&#x7684;&#x7C7B;&#x578B;&#x4E0D;&#x7B26;&#x5408;&#xFF0C;&#x5219;&#x663E;&#x793A;&#x9519;&#x8BEF;&#x4FE1;&#x606F; */
      if (fileType !== &apos;.pdf&apos;) {
        /* &#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x4EE5;&#x5BA2;&#x670D;&#x7684;&#x5F62;&#x5F0F;&#x663E;&#x793A; */
        return {
          type: &apos;agent-text&apos;,
          name: &apos;Siri&apos;, // &#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x865A;&#x62DF;&#x5BA2;&#x670D;&#x5904;&#x7406;&#x81EA;&#x52A8;&#x5316;&#x4EFB;&#x52A1;
          avatar: &apos;url&apos;,
          message: &apos;Sorry, we only accept pdf files!&apos;,
        };
      }
      const status = message.status;
      /* &#x4E0D;&#x5904;&#x7406;&#x6B63;&#x5728;&#x53D1;&#x9001;&#x7684;&#x6D88;&#x606F; */
      if (status !== &apos;sent&apos;) return message;
      const filename = message.filename;
      return [
        message,
        /* &#x589E;&#x52A0;&#x4E00;&#x6761;&#x5BA2;&#x670D;&#x6D88;&#x606F;&#xFF0C;&#x91CD;&#x7533;&#x5BF9;&#x4E8E;&#x5BA2;&#x6237;&#x6570;&#x636E;&#x7684;&#x5904;&#x7406;&#x539F;&#x5219; */
        {
          type: &apos;agent-text&apos;,
          name: &apos;Siri&apos;,
          avatar: &apos;url&apos;,
          message: `Thank you for uploading ${filename}, we will not share your info to any third party. Your data is safe with us.`,
        }
      ];
    },
  });

  // &#x4EE5;&#x4E0B;&#x5C55;&#x793A;&#x4E00;&#x4E9B;&#x9488;&#x5BF9;&#x591A;&#x6761;&#x6D88;&#x606F;&#x7684;&#x5904;&#x7406;&#x4F8B;&#x5B50;

  chatContent.onChange(function (messages) {
    if (messages[messages.length - 1].type !== &apos;visitor-text&apos;) return messages;
    let total = 0;
    let agentName = &apos;Siri&apos;;
    let agentAvatar = &apos;url&apos;;
    for (let i = messages.length - 1; i &gt;= 0; i --) {
      if (messages[i].type === &apos;system-message&apos;) continue;
      if (messages[i].type === &apos;agent-text&apos;) {
        agentName = messages[i].name;
        agentAvatar = messages[i].avatar;
        break;
      }
      total += 1;
    }
    if (total &lt;= 3) return messages;
    return messages.concat([{
      type: &apos;agent-text&apos;,
      name: agentName,
      avatar: agentAvatar,
      message: &apos;Please hold on for one sec&apos;,
    }]);
  });

  /**
   * &#x5F53;&#x5BA2;&#x6237;&#x8F93;&#x5165;&#x4E86;&#x542B;&#x6709; iPhone 8 &#x7684;&#x6587;&#x5B57;&#xFF0C;&#x800C;&#x804A;&#x5929;&#x673A;&#x5668;&#x4EBA;&#x4E0D;&#x77E5;&#x9053;&#x5E94;&#x8BE5;&#x600E;&#x4E48;&#x56DE;&#x7B54;&#x7684;&#x65F6;&#x5019;&#xFF0C;
   * &#x663E;&#x793A;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x6D88;&#x606F;&#x3002;&#x5E76;&#x4E14;&#xFF0C;&#x5982;&#x679C;&#x4E4B;&#x540E;&#x5BA2;&#x6237;&#x8F93;&#x5165;&#x4E86;&#x4ED6;&#x7684; email &#x5730;&#x5740;&#xFF0C;&#x5219;&#x5C06;&#x8FD9;&#x4E2A;&#x8BA2;&#x9605;&#x5730;&#x5740;&#x8BB0;&#x5F55;&#x5230;&#x670D;&#x52A1;&#x5668;&#xFF0C;
   * &#x5E76;&#x663E;&#x793A;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x544A;&#x77E5;&#x5DF2;&#x8BB0;&#x5F55;&#x3002;
   */
  const promotionMessage = [
    &apos;iPhone 8 will be released this September.&apos;,
    &apos;If you are interested, let me know your email address, we will keep you updated!&apos;,
  ].join(&apos;\n&apos;);
  chatContent.onChange(function (messages) {
    if (messages.length &lt; 2) return messages;
    const last = messages[messages.length - 1];
    const secondLast = messages[messages.length - 2];
    if (last.type !== &apos;bot-unkown&apos;) return messages;
    if (!/\biPhone 8\b/i.test(secondLast.text)) return messages;
    /* --- &#x5BA2;&#x6237;&#x8F93;&#x5165;&#x6D88;&#x606F;&#x5305;&#x542B; iPhone 8 &#x4E14;&#x804A;&#x5929;&#x673A;&#x5668;&#x4EBA;&#x65E0;&#x6CD5;&#x56DE;&#x7B54; --- */

    // &#x63D2;&#x5165;&#x4E00;&#x6761;&#x9884;&#x5148;&#x5B9A;&#x4E49;&#x597D;&#x7684;&#x6D88;&#x606F;
    return messages.slice(0, messages.length - 1).concat([{
      type: &apos;agent-text&apos;,
      name: &apos;Siri&apos;,
      avatar: &apos;url&apos;,
      message: promotionMessage,
    }]);
  });
  chatContent.onChange(function (messages) {
    if (messages.length &lt; 2) return messages;
    const last = messages[messages.length - 1];
    const secondLast = messages[messages.length - 2];
    if (last.type !== &apos;visitor-text&apos;) return messages;
    if (secondLast.type !== &apos;agent-text&apos; || secondLast.message !== promotionMessage) return messages;
    if (!/email pattern/.test(last.message)) return messages;
    /* --- &#x5BA2;&#x6237;&#x56DE;&#x590D;&#x4E86; email &#x5730;&#x5740; --- */
    const email = /email pattern/.match(last.message);
    subscribeInServer(email); // &#x628A;&#x8BE5;&#x5730;&#x5740;&#x53D1;&#x9001;&#x7ED9;&#x670D;&#x52A1;&#x5668;
    // &#x63D2;&#x5165;&#x4E00;&#x6761;&#x786E;&#x8BA4;&#x6D88;&#x606F;
    return messages.concat([
      {
        type: &apos;agent-text&apos;,
        name: &apos;Siri&apos;,
        avatar: &apos;url&apos;,
        message: `Your email address ${email} has been recorded, we will keep you updated!`,
      }
    ]);
  });
};

// prechat/postchat&#x76F8;&#x5173;&#x7684;&#x4F8B;&#x5B50;
Comm100API.onWindowWillDisplay = function (chatWindow) {
  // &#x5982;&#x679C;&#x4E0D;&#x662F;&#x6253;5&#x661F;&#x65F6;, &#x8BA9;&#x7528;&#x6237;&#x7559;comment
  chatWindow.postChatForm.onChange(function (oldFields, newFields) {
    const rating = newFields[0];
    if (parseInt(rating.value) &lt; 5) {
      return newFields.slice(0, 1).concat([{
        name: &apos;Comment&apos;,
        type: &apos;textarea&apos;,
        isRequired: true,
      }]);
    } else {
      return newFields.slice(0, 1);
    }
  });

  chatWindow.onRender(&apos;prechat.header&apos;, function () {
    const header = document.createElement(&apos;div&apos;);
    const img = document.createElement(&apos;img&apos;);
    img.src = &apos;https://www.comm100.com/logo.svg&apos;;
    header.appendChild(img);
    return header;
  });
};</code>
</code></pre>
</div>
</div>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
